define("agsjs/dijit/TOC",["dojo/_base/declare","dojo/has","dojo/aspect","dojo/_base/lang","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/dom-attr","dijit/_Widget","dijit/_TemplatedMixin","dojo/Evented","dojox/gfx","dojo/fx","dojo/fx/Toggler","esri/symbols/jsonUtils","esri/geometry/scaleUtils","esri/config","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/FeatureLayer","dojo/sniff"],function(e,t,i,o,r,s,a,n,d,h,l,c,y,L,f,g,u,_,p,v){var N=e([d,h],{templateString:'<div class="agsjsTOCNode"><div data-dojo-attach-point="rowNode" data-dojo-attach-event="onclick:_onClick"><span data-dojo-attach-point="contentNode" class="agsjsTOCContent"><span data-dojo-attach-point="spacerNode" style="display: none;width:16px !important;"></span><img src="${_blankGif}" alt="" data-dojo-attach-point="iconNode" /><span data-dojo-attach-point="checkContainerNode"></span><span data-dojo-attach-point="labelNode"></span></span></div><div data-dojo-attach-point="containerNode" style="display: none;"> </div></div>',rootLayer:null,serviceLayer:null,legend:null,rootLayerTOC:null,data:null,_childTOCNodes:[],hiddenIds:[],constructor:function(e,t){o.mixin(this,e)},postCreate:function(){a.set(this.rowNode,"paddingLeft",this.rootLayerTOC.tocWidget.indentSize*this.rootLayerTOC._currentIndent+"px"),this.data=this.legend||this.serviceLayer||this.rootLayer,this.blank=this.iconNode.src,null==this.hiddenIds[this.rootLayerTOC.config.title]&&(this.hiddenIds[this.rootLayerTOC.config.title]=[]);var e=!1;if(this.rootLayerTOC.config.hideGroupSublayers&&(null!=this.data._parentLayerInfo&&null!=this.data._parentLayerInfo.name&&this.rootLayerTOC.config.hideGroupSublayers.indexOf(this.data._parentLayerInfo.name)>-1?(e=!0,a.set(this.contentNode,"display","none"),null==this.serviceLayer.subLayerIds&&this.hiddenIds[this.rootLayerTOC.config.title].push(this.serviceLayer.id)):null!=this.data._parentLayerInfo&&null!=this.data._parentLayerInfo._parentLayerInfo&&null!=this.data._parentLayerInfo._parentLayerInfo.name&&this.rootLayerTOC.config.hideGroupSublayers.indexOf(this.data._parentLayerInfo._parentLayerInfo.name)>-1?(e=!0,a.set(this.contentNode,"display","none"),null==this.serviceLayer.subLayerIds&&(this.hiddenIds[this.rootLayerTOC.config.title].push(this.serviceLayer.id),this.hiddenIds[this.rootLayerTOC.config.title].push(this.data._parentLayerInfo.id),this.serviceLayer.minScale=this.serviceLayer._parentLayerInfo.minScale,this.serviceLayer.maxScale=this.serviceLayer._parentLayerInfo.maxScale)):null!=this.data._parentLayerInfo&&null!=this.data._parentLayerInfo._parentLayerInfo&&null!=this.data._parentLayerInfo._parentLayerInfo._parentLayerInfo&&null!=this.data._parentLayerInfo._parentLayerInfo._parentLayerInfo.name&&this.rootLayerTOC.config.hideGroupSublayers.indexOf(this.data._parentLayerInfo._parentLayerInfo._parentLayerInfo.name)>-1&&(e=!0,a.set(this.contentNode,"display","none"),null==this.serviceLayer.subLayerIds&&(this.hiddenIds[this.rootLayerTOC.config.title].push(this.serviceLayer.id),this.hiddenIds[this.rootLayerTOC.config.title].push(this.data._parentLayerInfo._parentLayerInfo.id),this.serviceLayer.minScale=this.serviceLayer._parentLayerInfo._parentLayerInfo.minScale,this.serviceLayer.maxScale=this.serviceLayer._parentLayerInfo._parentLayerInfo.maxScale))),this.legend&&!this.rootLayerTOC.config.noLegend?this._createLegendNode(this.legend):this.serviceLayer?this._createServiceLayerNode(this.serviceLayer):this.rootLayer&&this._createRootLayerNode(this.rootLayer),this.containerNode&&L&&(this.toggler=new L({node:this.containerNode,showFunc:y.wipeIn,hideFunc:y.wipeOut})),!this._noCheckNode){var t,i=this;if(!e&&this.data.parentLayerId>-1&&this.rootLayerTOC.config.radioLayers.indexOf(this.data._parentLayerInfo.name)>-1||-1==this.data.parentLayerId&&this.rootLayerTOC.config.radioLayers.indexOf(this.rootLayer.id)>-1)require(["dijit/form/RadioButton","dojo/domReady!"],function(e){var o;o=i.data.parentLayerId>-1?i.rootLayerTOC.config.title.replace(/ /g,"_")+"_"+i.data._parentLayerInfo.name.replace(/ /g,"_"):i.rootLayerTOC.config.title.replace(/ /g,"_"),t=new e({name:o,checked:i.data.visible},document.createElement("input")),t.placeAt(i.checkContainerNode),t.startup(),i.checkNode=t}),(!this.data._legends||this.data._legends&&-1==this.data._legends.length)&&a.set(this.iconNode,"visibility","hidden");else if(this.rootLayerTOC.config.openSubLayers.indexOf(this.data.name)>-1&&(this.data.visible=!0),dijit.form&&dijit.form.CheckBox?(t=new dijit.form.CheckBox({checked:this.data.visible}),t.placeAt(this.checkContainerNode),t.startup()):t=r.create("input",{type:"checkbox",checked:this.data.visible},this.checkContainerNode),this.checkNode=t,!this.rootLayerTOC.config.noLegend&&this.serviceLayer&&this.serviceLayer._legends&&1==this.serviceLayer._legends.length&&(a.set(this.checkContainerNode,"float","left"),a.set(this.checkContainerNode,"padding","0 0 0 16px")),!this.rootLayerTOC.config.noLegend&&this.serviceLayer&&this.serviceLayer._legends&&this.serviceLayer._legends.length>1&&a.set(this.iconNode,"visibility","hidden"),this.serviceLayer&&this.serviceLayer.subLayerIds)for(var o=0;o<this.serviceLayer.subLayerIds.length;o++)if(this.hiddenIds[this.rootLayer.id].indexOf(this.serviceLayer.subLayerIds[o])>-1){a.set(this.iconNode,"visibility","hidden");break}e&&this.iconNode&&-1==this.iconNode.src.indexOf("blank.gif")&&(a.set(this.contentNode,"display","block"),a.set(this.checkContainerNode,"display","none"),this.checkNode.checked=!0)}var n=this.data.visible;if(this.data._subLayerInfos){var d=!0;this.data._subLayerInfos.every(function(e){return!e.visible||(d=!1,!1)}),d&&(n=!1)}this.data.collapsed&&(n=!1),this.iconNode&&this.iconNode.src==this.blank&&(s.add(this.iconNode,"dijitTreeExpando"),s.add(this.iconNode,n?"dijitTreeExpandoOpened":"dijitTreeExpandoClosed")),this.iconNode?s.add(this.iconNode,"agsjsTOCIcon"):a.set(this.spacerNode,"display","inline-block"),this.containerNode&&a.set(this.containerNode,"display",n?"block":"none"),this.domNode.id="TOCNode_"+this.rootLayer.id+(this.serviceLayer?"_"+this.serviceLayer.id:"")+(this.legend?"_"+this.legend.id:""),"Wildfire Perimeters"==this.rootLayerTOC.config.title&&(a.set(this.labelNode,"position","relative"),"Wildfire Perimeters"!=this.labelNode.innerHTML&&a.set(this.labelNode,"top","-10px"),a.set(this.iconNode,"position","relative"),a.set(this.iconNode,"top","-5px"))},_createRootLayerNode:function(e){s.add(this.rowNode,"agsjsTOCRootLayer"),s.add(this.labelNode,"agsjsTOCRootLayerLabel");var t=this.rootLayerTOC.config.title;if(""===t)esri.hide(this.rowNode),e.show(),this.rootLayerTOC._currentIndent--;else if(void 0===t)if(e.name)t=e.name;else{var i=e.url.toLowerCase().indexOf("/rest/services/"),o=e.url.toLowerCase().indexOf("/mapserver",i);t=e.url.substring(i+15,o)}if(e.collapsed=this.rootLayerTOC.config.collapsed,this.rootLayerTOC.config.slider){this.sliderNode=r.create("div",{class:"agsjsTOCSlider"},this.rowNode,"last");var d=this;require(["dijit/form/HorizontalSlider","dijit/form/HorizontalRuleLabels","dijit/form/HorizontalRule","dojo/domReady!"],function(t,i,o){d.slider=new t({showButtons:!1,value:100*e.opacity,intermediateChanges:!0,tooltip:"adjust transparency",onChange:function(t){e.setOpacity(t/100),e.refresh()},style:"height: 30px",layoutAlign:"right"}),d.slider.placeAt(d.sliderNode);try{if(d.rootLayerTOC.config.slider_ticks){var s=r.create("div");d.sliderNode.appendChild(s);var a=new o({count:d.rootLayerTOC.config.slider_ticks});a.placeAt(s)}if(d.rootLayerTOC.config.slider_labels){var n=r.create("div");d.sliderNode.appendChild(n);var h=new i({labels:d.rootLayerTOC.config.slider_labels});h.placeAt(n)}}catch(e){alert("Error in toc.js: "+e.message)}e.on("opacity-change",function(e){d.slider.set("value",100*e.opacity)})})}if(e._tocInfos)this._createChildrenNodes(e._tocInfos,"serviceLayer");else if(e.renderer&&!this.rootLayerTOC.config.noLegend){var h=e.renderer;if(h.infos){var l=h.infos;h.defaultSymbol&&l.length>0&&"[all other values]"!=l[0].label&&l.unshift({label:"[all other values]",symbol:h.defaultSymbol});var c=h.attributeField+(h.normalizationField?"/"+h.normalizationField:"");c+=(h.attributeField2?"/"+h.attributeField2:"")+(h.attributeField3?"/"+h.attributeField3:"");var y=r.create("div",{},this.containerNode);a.set(y,"paddingLeft",this.rootLayerTOC.tocWidget.indentSize*this.rootLayerTOC._currentIndent+"px"),y.innerHTML=c,this._createChildrenNodes(l,"legend")}else this._setIconNode(e.renderer,this.iconNode,this),r.destroy(this.containerNode),this.containerNode=null}else a.set(this.iconNode,"visibility","hidden");this.labelNode.innerHTML=t,n.set(this.rowNode,"title",t)},_createServiceLayerNode:function(e){this.labelNode.innerHTML=e.name,e._subLayerInfos?(s.add(this.rowNode,"agsjsTOCGroupLayer"),s.add(this.labelNode,"agsjsTOCGroupLayerLabel"),this._createChildrenNodes(e._subLayerInfos,"serviceLayer")):(s.add(this.rowNode,"agsjsTOCServiceLayer"),s.add(this.labelNode,"agsjsTOCServiceLayerLabel"),this.rootLayer.tileInfo&&(this._noCheckNode=!0),!this.rootLayerTOC.config.noLegend&&e._legends?1==e._legends.length?(this.iconNode.src=this._getLegendIconUrl(e._legends[0]),r.destroy(this.containerNode),this.containerNode=null):this._createChildrenNodes(e._legends,"legend"):(r.destroy(this.iconNode),this.iconNode=null,r.destroy(this.containerNode),this.containerNode=null))},_createLegendNode:function(e){this._noCheckNode=!0,r.destroy(this.containerNode),s.add(this.labelNode,"agsjsTOCLegendLabel"),this._setIconNode(e,this.iconNode,this);var t=e.label;void 0===e.label&&(void 0!==e.value&&(t=e.value),void 0!==e.maxValue&&(t=e.minValue+" - "+e.maxValue)),this.labelNode.appendChild(document.createTextNode(t))},_setIconNode:function(e,i,s){var n=this._getLegendIconUrl(e);if(n)i.src=n,e.symbol&&e.symbol.width&&e.symbol.height&&(i.style.width=e.symbol.width,i.style.height=e.symbol.height);else if(e.symbol){var d=this.rootLayerTOC.tocWidget.swatchSize[0],h=this.rootLayerTOC.tocWidget.swatchSize[1];e.symbol.width&&e.symbol.height&&(d=e.symbol.width,h=e.symbol.height);var l=r.create("span",{});a.set(l,{width:d+"px",height:h+"px",display:"inline-block"}),r.place(l,i,"replace"),s.iconNode=l;var y=f.getShapeDescriptors(e.symbol),L=c.createSurface(l,d,h);y&&(t("ie")?window.setTimeout(o.hitch(this,"_createSymbol",L,y,d,h),500):this._createSymbol(L,y,d,h))}else console&&console.log("no symbol in renderer")},_createSymbol:function(e,t,i,o){var r=e.createShape(t.defaultShape);t.fill&&r.setFill(t.fill),t.stroke&&r.setStroke(t.stroke),r.applyTransform({dx:i/2,dy:o/2})},_getLegendIconUrl:function(e){var i=e.url;return null!=i&&-1==i.indexOf("data")&&(!t("ie")&&e.imageData&&e.imageData.length>0?i="data:image/png;base64,"+e.imageData:(0!==i.indexOf("http")&&(i=this.rootLayer.url+"/"+this.serviceLayer.id+"/images/"+i),this.rootLayer.credential&&this.rootLayer.credential.token?i=i+"?token="+this.rootLayer.credential.token:u.defaults.io.alwaysUseProxy&&(i=u.defaults.io.proxyUrl+"?"+i))),i},_createChildrenNodes:function(e,t){this.rootLayerTOC._currentIndent++;for(var i=[],o=0,r=e.length;o<r;o++){var s=e[o],a={rootLayerTOC:this.rootLayerTOC,rootLayer:this.rootLayer,serviceLayer:this.serviceLayer,legend:this.legend};a[t]=s,a.data=s,"legend"==t&&(s.id="legend"+o);var n=new N(a);n.placeAt(this.containerNode),i.push(n)}this._childTOCNodes=i,this.rootLayerTOC._currentIndent--},_toggleContainer:function(e){this.iconNode&&(s.contains(this.iconNode,"dijitTreeExpandoClosed")||s.contains(this.iconNode,"dijitTreeExpandoOpened"))&&(e?(s.remove(this.iconNode,"dijitTreeExpandoClosed"),s.add(this.iconNode,"dijitTreeExpandoOpened")):!1===e?(s.remove(this.iconNode,"dijitTreeExpandoOpened"),s.add(this.iconNode,"dijitTreeExpandoClosed")):(s.toggle(this.iconNode,"dijitTreeExpandoClosed"),s.toggle(this.iconNode,"dijitTreeExpandoOpened")),s.contains(this.iconNode,"dijitTreeExpandoOpened")?this.toggler?this.toggler.show():esri.show(this.containerNode):this.toggler?this.toggler.hide():esri.hide(this.containerNode),!this.rootLayer||this.serviceLayer||this.legend||(this.rootLayerTOC.config.collapsed=s.contains(this.iconNode,"dijitTreeExpandoClosed")))},expand:function(){this._toggleContainer(!0)},collapse:function(){this._toggleContainer(!1)},show:function(){esri.show(this.domNode)},hide:function(){esri.hide(this.domNode)},_adjustToState:function(){if(this.checkNode&&0==this.checkNode.disabled){var e=this.legend?this.legend.visible:this.serviceLayer?this.serviceLayer.visible:!!this.rootLayer&&this.rootLayer.visible;this.checkNode.set?this.checkNode.set("checked",e):this.checkNode.checked=e}if(this.serviceLayer){var t=parseInt(g.getScale(this.rootLayerTOC.tocWidget.map)),i=0!=this.serviceLayer.maxScale&&t<parseInt(this.serviceLayer.maxScale)||0!=this.serviceLayer.minScale&&t>parseInt(this.serviceLayer.minScale);i?s.add(this.domNode,"agsjsTOCOutOfScale"):s.remove(this.domNode,"agsjsTOCOutOfScale"),this.checkNode&&(this.checkNode.set?this.checkNode.set("disabled",i):this.checkNode.disabled=i),i?a.set(this.labelNode,"color","gray"):a.set(this.labelNode,"color",""),i&&this.hiddenIds[this.rootLayerTOC.config.title].indexOf(this.serviceLayer.id)>-1?a.set(this.rowNode,"display","none"):this.hiddenIds[this.rootLayerTOC.config.title].indexOf(this.serviceLayer.id)>-1&&a.set(this.rowNode,"display","block"),i||"Big Game GMU"!=this.labelNode.innerHTML&&"Goat GMU"!=this.labelNode.innerHTML&&"Bighorn GMU"!=this.labelNode.innerHTML||(gmu==this.labelNode.innerHTML?a.set(this.rowNode,"display","block"):a.set(this.rowNode,"display","none"))}this._childTOCNodes.length>0&&this._childTOCNodes.forEach(function(e){e._adjustToState()})},_onClick:function(e){var t=e.target;if(t==this.checkNode||dijit.getEnclosingWidget(t)==this.checkNode){if(this.serviceLayer){if(this.checkNode.id.indexOf("Radio")>-1){var i,o=this.rootLayer.layerInfos;if(-1==this.serviceLayer.parentLayerId)for(i=0;i<o.length;i++)o[i].name!=this.serviceLayer.name&&-1==o[i].parentLayerId&&(o[i].visible=!1);else for(i=0;i<o.length;i++)o[i].name!=this.serviceLayer.name&&-1!=o[i].parentLayerId&&this.rootLayerTOC.config.radioLayers.indexOf(o[o[i].parentLayerId].name)>-1&&(o[i].visible=!1)}if("Game Species"==this.rootLayer.id&&-1==this.serviceLayer.parentLayerId){"Bighorn Sheep"==this.serviceLayer.name?gmu="Bighorn GMU":"Mountain Goat"==this.serviceLayer.name?gmu="Goat GMU":gmu="Big Game GMU";for(var r=0;r<this.rootLayerTOC.tocWidget._rootLayerTOCs.length;r++)if("Hunter Reference"==this.rootLayerTOC.tocWidget._rootLayerTOCs[r].config.title){this.rootLayerTOC.tocWidget._rootLayerTOCs[r].rootLayer.setVisibleLayers(this.rootLayerTOC.tocWidget._rootLayerTOCs[r]._rootLayerNode._getVisibleLayers(),!0),this.rootLayerTOC.tocWidget._rootLayerTOCs[r]._rootLayerNode.rootLayerTOC._refreshLayer(),this.rootLayerTOC.tocWidget._rootLayerTOCs[r]._rootLayerNode.rootLayerTOC._adjustToState();break}}this.serviceLayer.visible=this.checkNode&&this.checkNode.checked,this.rootLayer.setVisibleLayers(this._getVisibleLayers(),!0),this.rootLayerTOC._refreshLayer()}else this.rootLayer&&(this.rootLayer.setVisibleLayers&&this.rootLayer.setVisibleLayers(this._getVisibleLayers(),!0),this.rootLayer.setVisibility(this.checkNode&&this.checkNode.checked));!1!==this.rootLayerTOC.config.autoToggle&&(this.checkNode.id.indexOf("Radio")>-1&&this._setRadioToggle(this.rootLayerTOC._rootLayerNode._childTOCNodes,this.serviceLayer.parentLayerId),this._toggleContainer(this.checkNode&&this.checkNode.checked)),this.rootLayerTOC._adjustToState()}else t==this.iconNode&&this._toggleContainer()},_setRadioToggle:function(e,t){e.forEach(function(e){if(e.serviceLayer.parentLayerId==t){var i=e.checkNode&&e.checkNode.checked;(s.contains(e.iconNode,"dijitTreeExpandoClosed")||s.contains(e.iconNode,"dijitTreeExpandoOpened"))&&(i?(s.remove(e.iconNode,"dijitTreeExpandoClosed"),s.add(e.iconNode,"dijitTreeExpandoOpened")):!1===i?(s.remove(e.iconNode,"dijitTreeExpandoOpened"),s.add(e.iconNode,"dijitTreeExpandoClosed")):(s.toggle(e.iconNode,"dijitTreeExpandoClosed"),s.toggle(e.iconNode,"dijitTreeExpandoOpened")),s.contains(e.iconNode,"dijitTreeExpandoOpened")?e.toggler?e.toggler.show():esri.show(e.containerNode):e.toggler?e.toggler.hide():esri.hide(e.containerNode),!e.rootLayer||e.serviceLayer||e.legend||(e.rootLayerTOC.config.collapsed=s.contains(e.iconNode,"dijitTreeExpandoClosed")))}e._childTOCNodes&&this._setRadioToggle(e._childTOCNodes,t)},this)},_setSubLayerVisibilitiesFromGroup:function(e){e._subLayerInfos&&e._subLayerInfos.length>0&&e._subLayerInfos.forEach(function(t){t.visible=e.visible,t._subLayerInfos&&t._subLayerInfos.length>0&&this._setSubLayerVisibilitiesFromGroup(t)},this)},_getVisibleLayers:function(){var e=[];if(!this.rootLayer.layerInfos)return e.push(-1),e;for(var t=this.rootLayer.layerInfos,i=parseInt(g.getScale(this.rootLayerTOC.tocWidget.map)),o=0;o<t.length;o++)if(null==t[o]._subLayerInfos&&(t[o].visible||this.hiddenIds[this.rootLayerTOC.config.title].indexOf(t[o].id)>-1)){var r=!0;if(0!=t[o].maxScale&&i<t[o].maxScale||0!=t[o].minScale&&i>t[o].minScale)continue;if(t[o].parentLayerId>-1){var s=t[o];do{if(s=t[s.parentLayerId],!s.visible){r=!1;break}}while(s.parentLayerId>-1);if(r)if("Big Game GMU"==t[o].name||"Goat GMU"==t[o].name||"Bighorn GMU"==t[o].name){if(gmu!=t[o].name)continue;e.push(t[o].id)}else e.push(t[o].id)}else e.push(t[o].id)}return 0===e.length&&e.push(-1),e},_findTOCNode:function(e){if(this.serviceLayer&&this.serviceLayer.id==e)return this;if(this._childTOCNodes.length>0)for(var t=null,i=0,o=this._childTOCNodes.length;i<o;i++)if(t=this._childTOCNodes[i]._findTOCNode(e),t)return t;return null}}),T=e([d],{_currentIndent:0,rootLayer:null,tocWidget:null,constructor:function(e,t){this.config=e.config||{},this.rootLayer=e.config.layer,this.tocWidget=e.tocWidget,this.tries=0},postCreate:function(){this.rootLayer instanceof _||this.rootLayer instanceof p?this._legendResponse?this._createRootLayerTOC():this._getLegendInfo():this._createRootLayerTOC()},_getLegendInfo:function(){var e="";e=this.rootLayer.url+"/legend",this.tries++;esri.request({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json",load:o.hitch(this,this._processLegendInfo),error:o.hitch(this,this._processLegendError)})},_processLegendError:function(e){var t=this;if(console.log("Legend failed to load: "+this.rootLayer.id),this.tries<5)setTimeout(function(e){e._getLegendInfo()},3e3,t);else if(5==this.tries){this._createRootLayerTOC();var i="";if(this.rootLayer.id.indexOf("Motor")>-1&&(i=" from the USFS servers"),this.rootLayer.id.indexOf("BLM")>-1&&(i=" from the BLM servers"),this.rootLayer.id.indexOf("Wildlife")>-1&&(i=" from the National Interagency Fire Center servers"),-1==e.message.toLowerCase().indexOf("services/"))alert("We are having trouble retrieving the "+this.rootLayer.id+" legend"+i+", we will continue to try to load it.","Data Error");else{var o=e.message.substring(e.message.toLowerCase().indexOf("services/")+9,e.message.toLowerCase().indexOf("/mapserver"));e.message.indexOf("HunterBase")>-1?o="Hunter Reference":e.message.indexOf("MVUM")>-1?o="MVUM":e.message.indexOf("GameSpecies")>-1?o="Game Species":e.message.indexOf("FishingAtlas_Base")>-1?o="Fishing Reference":e.message.indexOf("FishingAtlas_Main")>-1&&(o="Fishing Info"),alert("We are having trouble retrieving the "+o+" legend"+i+", we will continue to try to load it.","Data Error")}setTimeout(function(e){e._getLegendInfo()},3e4,t)}else setTimeout(function(e){e._getLegendInfo()},3e4,t)},_processLegendInfo:function(e){this._legendResponse=e;var t=this.rootLayer;if(!t._tocInfos){var i={};t.layerInfos.forEach(function(e){i[""+e.id]=e,e.visible=e.defaultVisibility,t.visibleLayers&&!e.subLayerIds&&(-1==t.visibleLayers.indexOf(e.id)?e.visible=!1:e.visible=!0)}),e.layers&&e.layers.forEach(function(e){var t=i[""+e.layerId];t&&e.legend&&(t._legends=e.legend)}),t.layerInfos.forEach(function(e){if(e.subLayerIds){var t=[];e.subLayerIds.forEach(function(o,r){null===i[o]?alert("Warning: missing layer in "+e.name+" with sublayer id "+o):(t[r]=i[o],t[r]._parentLayerInfo=e)}),e._subLayerInfos=t}});var o=[];t.layerInfos.forEach(function(e){-1==e.parentLayerId&&o.push(e)}),t._tocInfos=o}this._createRootLayerTOC()},_createRootLayerTOC:function(){this.rootLayer.loaded?(this._rootLayerNode=new N({rootLayerTOC:this,rootLayer:this.rootLayer}),this._rootLayerNode.placeAt(this.domNode),this._visHandler=this.rootLayer.on("visibility-change",o.hitch(this,this._adjustToState)),this.rootLayer instanceof _&&(this._visLayerHandler=i.after(this.rootLayer,"setVisibleLayers",o.hitch(this,this._onSetVisibleLayers),!0)),this._adjustToState(),this._loaded=!0,this.onLoad()):this.rootLayer.on("load",o.hitch(this,this._createRootLayerTOC))},onLoad:function(){},_refreshLayer:function(){var e=this.rootLayer,t=this.tocWidget.refreshDelay;this._refreshTimer&&(window.clearTimeout(this._refreshTimer),this._refreshTimer=null),this._refreshTimer=window.setTimeout(function(){e.setVisibleLayers(e.visibleLayers)},t)},_onSetVisibleLayers:function(e,t){if(!t){this._rootLayerNode._childTOCNodes,this.config.radioLayers,this._rootLayerNode;this.rootLayer.layerInfos.forEach(function(t){var i=map.getScale(),o=0!=t.maxScale&&i<parseInt(t.maxScale)||0!=t.minScale&&i>parseInt(t.minScale);-1!=e.indexOf(t.id)?t.visible=!0:t._subLayerInfos||o||-1==e.indexOf(t.parentLayerId)||(t.visible=!1)}),this._adjustToState()}},_adjustToState:function(){this._rootLayerNode._adjustToState()},_adjustToState2:function(){this._rootLayerNode&&this._rootLayerNode.checkNode.checked&&this.rootLayer.setVisibleLayers?(this.rootLayer.setVisibleLayers(this._rootLayerNode._getVisibleLayers(),!0),this._rootLayerNode._adjustToState(),this._refreshLayer()):this._rootLayerNode&&this._rootLayerNode._adjustToState()},destroy:function(){this._visHandler&&(this._visHandler.remove(),this._visHandler=null),this._visLayerHandler&&(this._visLayerHandler.remove(),this._visLayerHandler=null)}}),m=e("agsjs.dijit.TOC",[d,l],{indentSize:25,swatchSize:[30,30],refreshDelay:500,layerInfos:null,constructor:function(e,t){if(e=e||{},!e.map)throw new Error("no map defined in params for TOC");this.layerInfos=e.layerInfos,o.mixin(this,e)},postCreate:function(){this._createTOC()},onLoad:function(){},_createTOC:function(){r.empty(this.domNode),this._rootLayerTOCs=[];for(var e=0,t=this.layerInfos.length;e<t;e++){var i=this.layerInfos[e],s=new T({config:i,tocWidget:this});this._rootLayerTOCs.push(s),this._checkLoadHandler=s.on("load",o.hitch(this,"_checkLoad")),s.placeAt(this.domNode),this._checkLoad()}this._zoomHandler||(this._zoomHandler=this.map.on("zoom-end",o.hitch(this,"_adjustToState"))),this._loadHandler||(this._loadHandler=this.on("load",function(){window.setTimeout(o.hitch(this,"_adjustToState"),200)}))},_checkLoad:function(){var e=!0;this._rootLayerTOCs.every(function(t){return!!t._loaded||(e=!1,!1)}),e&&(this.onLoad(),this.emit("load"))},_adjustToState:function(){this._rootLayerTOCs.forEach(function(e){e._adjustToState2()})},refresh:function(){this._createTOC()},destroy:function(){this._zoomHandler.remove(),this._zoomHandler=null,this._loadHandler.remove(),this._loadHandler=null,this._checkLoadHandler.remove(),this._checkLoadHandler=null},findTOCNode:function(e,t){var i;return this._rootLayerTOCs.every(function(t){return t.rootLayer!=e||(i=t,!1)}),null!=t&&i.rootLayer instanceof _?i._rootLayerNode._findTOCNode(t):i?i._rootLayerNode:null}});return m});