define(["dojo/_base/declare","dojo/_base/lang"],function(e,r){return{mlGetPoints:function(){for(var e=null,r=/'/g,a=/"/g,n=0;n<drawGraphicsCount.length;n++){var t=map.getLayer(drawGraphicsCount[n]).graphics[0];if("point"==t.geometry.type){e||(e="&point="),"&point="!=e&&(e+=",");var i=t.symbol.color.toRgb(),l="m";7==t.symbol.size?l="s":21==t.symbol.size&&(l="l");var s="y";255==i[0]?s="r":255==i[1]?s="g":255==i[2]&&(s="b"),e+=l+"|"+s+"|"+parseInt(t.geometry.x)+"|"+parseInt(t.geometry.y);var o=1;if(detectmob&&(o=2),map.getLayer(drawGraphicsCount[n]).graphics[o]?(t=2==o?map.getLayer(drawGraphicsCount[n]).title:map.getLayer(drawGraphicsCount[n]).graphics[o].symbol.text,t=t.replace(/``/g,"\\%22").replace(/`/g,"\\%27"),e+="|"+t.replace(r,"%27").replace(a,"\\%22").replace(/,/g,";").replace(/\n/g,"%0D").replace(/\?/g,"%3F")):e+="|Way%20Point",map.getLayer(drawGraphicsCount[n]).desc){var p=map.getLayer(drawGraphicsCount[n]).desc;"."==p[p.length-1]&&(p+=" "),p=p.replace(/``/g,"\\%22").replace(/`/g,"\\%27"),e+="|"+p.replace(r,"\\%27").replace(a,"\\%22").replace(/,/g,";").replace(/\n/g,"%0D").replace(/\?/g,"%3F")}}}return e},mlGetLayers:function(){for(var e="&layer="+mapBasemap+"|",r=map.getLayersVisibleAtScale(),a=0;a<r.length;a++)if("esri.layers.ArcGISDynamicMapServiceLayer"==r[a].declaredClass){if(!r[a].visible)continue;"|"!=e.substring(e.length-1,e.length)&&(e+=",");var n=r[a].opacity.toString();e+=r[a].id+"|"+n.substring(0,4)+"|";for(var t=0;t<r[a].layerInfos.length;t++)if(-1!=r[a].visibleLayers.indexOf(t)){for(var i=t;-1!=r[a].layerInfos[i].parentLayerId;)-1==r[a].visibleLayers.indexOf(r[a].layerInfos[i].parentLayerId)&&r[a].visibleLayers.push(r[a].layerInfos[i].parentLayerId),i=r[a].layerInfos[i].parentLayerId;r[a].visibleLayers=r[a].visibleLayers.sort(function(e,r){return e-r})}for(var l=0;l<r[a].visibleLayers.length;l++)0!=l&&(e+="-"),e+=r[a].visibleLayers[l]}return e},addPoints:function(e,r){require(["esri/graphic","esri/layers/GraphicsLayer","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","dojo/_base/Color","esri/geometry/Geometry","esri/SpatialReference"],function(r,a,n,t,l,s,o,p){var c,g,y,d,f,m,u,w,h=e.split(","),L=/;/g,b=/\\'/g,v=/\\"/g;for(i=0;i<h.length;i++){if(w=h[i].split("|"),w.length>=4&&w.length<7)f="s"==w[0]?7:"l"==w[0]?21:14,"b"==w[1]?(m=new s([0,0,255,.6]),u=new s([0,0,200])):"g"==w[1]?(m=new s([0,255,0,.6]),u=new s([0,150,5])):"y"==w[1]?(m=new s([100,100,100,.6]),u=new s([100,100,100])):(m=new s([255,0,0,.6]),u=new s([255,0,10])),c=new t(t.STYLE_CIRCLE,f,new l(l.STYLE_SOLID,u,1),m),y=w.length>4?w[4].replace(L,",").replace(v,"``").replace(b,"`"):"Way Point",d=w.length>5?w[5].replace(L,",").replace(v,"``").replace(b,"`"):"",g=new n(parseFloat(w[2]),parseFloat(w[3]),new p({wkid:wkid}));else{if(!(w.length>6))return void alert("Could not add all of the Way Points. This can happen if a long map URL was emailed.","Note",null,!0,!0);if(w[4].indexOf("h")>-1){var I=w[2].split(";");I.push(parseFloat(w[3])),m=new s(I),u=new s("#"+w[4].substr(1)),I=null}else m=new s("#"+parseInt(w[2]).toString(16)),u=new s("#"+parseInt(w[4]).toString(16));c=new t(t.STYLE_CIRCLE,w[1],new l(l.STYLE_SOLID,u,1),m),g=new n(parseFloat(w[6]),parseFloat(w[7]),new p({wkid:wkid})),y=w.length>8?w[8].replace(L,",").replace(b,"'").replace(v,'"'):"Way Point",d=w.length>9?w[9].replace(L,",").replace(b,"'").replace(v,'"'):""}addPoint(g,y,d,c)}y=null,g=null,c=null,m=null,u=null,h=null,w=null})},getMapLink:function(){var e;e=-1!=window.location.href.indexOf("&")?window.location.href.substring(0,window.location.href.indexOf("&")):window.location.href,e=e.substring(0,e.indexOf("index")),e+=app+"/index.aspx?",e+="prj="+wkid+"&extent="+parseInt(map.extent.xmin)+","+parseInt(map.extent.ymin)+","+parseInt(map.extent.xmax)+","+parseInt(map.extent.ymax);var r=this.mlGetLayers();r&&(e+=r);var a=this.mlGetPoints();if(a&&(e+=a),"function"==typeof getHB1298Points){var n=getHB1298Points();n&&""!=n&&(e+=n)}return e}}});