define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_AttachMixin","dojo/text!javascript/templates/Bookmark.html","dojo/_base/lang","dojo/dom","dojo/on","dojo/dom-construct","dijit/registry","dijit/form/Button","dojox/mobile","dojox/mobile/compat","dojox/mobile/parser","dojox/mobile/TabBar","dojox/mobile/TabBarButton","dojox/mobile/View","dojox/mobile/ScrollableView"],function(e,o,a,t,r,i,s,n,l,d,m,c,p,g,u,b,h,k,y){widgetsInTemplate=!0;var f=e([o,a,t,r],{templateString:i,defaultHelp:"This tool allows you to save the current map view including: way points, selected map layers, and base map layer in your <b>browser's bookmarks</b> or save it to an icon on your home screen. The advantage to this is that you can clear your browser history, including cookies and your bookmarks will not be lost. The disadvantage is that browsers have a limit on the length of a URL address, so it may not be able to save all of your Way Points. Also, if you started this web app from an icon on your home screen it will run in fullscreen mode and the Settings icon will be hidden. To use this feature, please start this web page in your browser.<br/><br/>When you press the 'Create Bookmark' button the page will reload with a new URL address. Then to save it:<br/><br>On Chrome press the settings button <img src='assets/images/androidBookmark.png'/>, then press the star button or select 'Add to Home Screen'.<br/><br/>On iPhone press the settings button <img src='assets/images/iosBookmark.png' style='height:26px'/>, then select 'Add Bookmark' or 'Add to Home Screen'.<br/><br/><strong>Email a Bookmark</strong>: If you would like to email the current map use 'Email Link' located in Links in the main menu. Good for a limited number of Way Points.<br/><br/>",constructor:function(e){s.mixin(this,e),e=e||{}},startup:function(){this._setBookmarks()},_loadKml:function(){require(["esri/layers/KMLLayer","esri/geometry/webMercatorUtils","esri/graphicsUtils","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol","dojo/_base/Color"],function(e,o,a,t,r,i){showLoading(),esri.config.defaults.io.proxyUrl="/proxy/DotNet/proxy.ashx",esriConfig.defaults.io.alwaysUseProxy=!1;var s=document.getElementById("kmlFile").value;regexp=/([^a-zA-Z0-9 \/:&\?$\-\'=,;+\.!_\*()])/g,s=s.replace(regexp,"");var n=new e(s);map.addLayer(n),closeMenu(),slideLeft(document.getElementById("bookmarkPane"));var l=n.on("load",function(e){l.remove(),console.log(e.layer.id);var t=null,r=n.getLayers(),i=null;r[0].folders&&console.log("Folders="+r[0].folders.length),r[0].graphics&&console.log("Graphics="+r[0].graphics.length),dojo.forEach(r,function(e){e.graphics&&e.graphics.length>0&&(4326==e.graphics[0].geometry.spatialReference.wkid?i=o.geographicToWebMercator(a.graphicsExtent(e.graphics)):102100==e.graphics[0].geometry.spatialReference.wkid?i=a.graphicsExtent(e.graphics):alert("need to convert spatial reference"),i&&(t?t.union(i):t=i))}),t&&map.setExtent(t),hideLoading()});n.on("error",function(e){hideLoading(),alert(e.error.message,"Warning")})})},_hideAll:function(){document.getElementById("addBookmark").style.display="none",document.getElementById("addBrowserBookmark").style.display="none",document.getElementById("bmBtn").className="buttonBar",document.getElementById("brBtn").className="buttonBar"},_showAddBookmark:function(){this._hideAll(),document.getElementById("addBookmark").style.display="block",document.getElementById("bmBtn").className="buttonBarSelected",bmHelp.setContent('This tool allows you to save the current map view including: way points, selected map layers, and base map layer in your <b>browser\'s local storage</b>. If you delete your browser history be sure to uncheck <b>"cookies & other site data"</b> to keep your bookmarks. The disadvantage to this is that you can never clear your cookies without losing all of your bookmarks. Also, Safari on mobile recently removed the option to uncheck cookies, therefore clearing history will delete all of your saved bookmarks. There is a limit of 5mb that can be stored per website domain. <br/><br/><strong>Add a Bookmark: </strong>Enter a label for your boomark and press the Add button.<br/><br/><strong>Load a Bookmark: </strong>Click on the label or <img style="vertical-align:middle; height:30px;" src="assets/images/i_bookmark.png"/> button to load a bookmark.<br/><br/><strong>Remove a Bookmark: </strong>Clicking on the <img style="vertical-align:middle" src="assets/images/w_close_red.png"/> button will delete a bookmark.<br/><br/><strong>Email a Bookmark</strong>: If you would like to email the current map use "Email Link" located in Links in the main menu.  Good for a limited number of Way Points.<br/><br/>')},_showBrowserBookmark:function(){this._hideAll(),document.getElementById("addBrowserBookmark").style.display="block",document.getElementById("brBtn").className="buttonBarSelected",bmHelp.setContent(this.defaultHelp)},_setBookmarks:function(){try{var e=getCookie("bm_"+app.toLowerCase());if(""!=e)for(var o=e.split("*"),a=0;a<o.length;a++){var t=getCookie("bm"+app.toLowerCase()+"_"+o[a]);t=t.replace(/\$/g,";"),this._updateBookmarkContent(t)}else this._updateBookmarkContent("Colorado|-12350000,4250000,-11150000,5250000"),setCookie("bm"+app.toLowerCase()+"_Colorado","Colorado|-12350000,4250000,-11150000,5250000"),setCookie("bm_"+app.toLowerCase(),"Colorado")}catch(e){alert("Error in javascript/bookmark.js _setBookmarks() "+e.message,"Code Error",e)}},_updateBookmarkContent:function(e){try{var o=e.indexOf("|"),a=e.substring(0,o),t=e.substring(o+1);t=t.replace(/%0D/g,"\n").replace(/%3F/g,"?").replace(/%22/g,'"').replace(/%27/g,"'").replace(/%26/g,"&");var r=d.create("span",{style:{textDecoration:"none",cursor:"pointer"},id:"link"+a,innerHTML:"<img style='vertical-align:middle;' src='assets/images/i_bookmark.png'/> "+a});l(r,"click",s.hitch(this,function(e){this._loadBookmark(t)}));var i=d.create("img",{src:"assets/images/w_close_red.png",style:{cursor:"pointer",position:"relative",float:"right",right:"10px",height:"30px"},id:a,onclick:s.hitch(this,function(e){this._removeBookmark(e.currentTarget.id)})}),n=d.create("br",{id:"br1"+a}),m=d.create("br",{id:"br2"+a});d.place(r,this.bookmarkTab,"before"),d.place(i,this.bookmarkTab,"before"),d.place(n,this.bookmarkTab,"before"),d.place(m,this.bookmarkTab,"before")}catch(e){alert("Error in javascript/bookmark.js _updateBookmarkContent() "+e.message,"Code Error",e)}},_loadBrowserBookmark:function(e){require(["javascript/graphicFuncs"],function(e){"function"==typeof ga&&ga("send","event","bookmark","click","Bookmark","1"),"function"==typeof gtag&&gtag("event","widget_click",{widget_name:"Bookmark"});var o=e.getMapLink();showLoading(),window.location.assign(o)})},_addBookmark:function(e){try{var o;"function"==typeof ga&&ga("send","event","bookmark","click","Bookmark","1"),"function"==typeof gtag&&gtag("event","widget_click",{widget_name:"Bookmark"});var a=getCookie("bm_"+app.toLowerCase()),t=this.bookmarkName.value;if(regexp=/([^a-zA-Z0-9 \-\.!_()])/g,t=t.replace(regexp,""),""==t)return void alert("Must give the bookmark a name.","Note");if(t.indexOf("|")>-1||t.indexOf("$")>-1)return void alert("Bookmark name cannot contain the '|' or the '$' character.","Note");var r=map.extent.xmin+","+map.extent.ymin+","+map.extent.xmax+","+map.extent.ymax,i=this;require(["javascript/graphicFuncs"],function(e){o=e.mlGetPoints(),o&&(r+=o),"function"==typeof getHB1298Points&&(o||(o=""),o=getHB1298Points(),o&&""!=o&&(r+=o)),o=e.mlGetLayers(),o&&(r+=o),r=r.replace(/;/g,"$"),o=t+"|"+r,i._updateBookmarkContent(o),a.length>0&&(a+="*"),a+=t,setCookie("bm_"+app.toLowerCase(),a),setCookie("bm"+app.toLowerCase()+"_"+t,o)}),this.bookmarkName.value="",this.bookmarkName.blur(),document.body.focus()}catch(e){alert("Error in javascript/bookmark.js _addBookmark() "+e.message,"Code Error",e)}},_loadBasemapsToc:function(e,o){initBasemaps();var a=setInterval(function(){"none"==document.getElementById("basemapLoading").style.display&&(clearInterval(a),basemapFlag=!0,o._loadBookmark(e))},50)},_loadBookmark:function(e){try{if(showLoading(),e.indexOf("layer=")&&!basemapFlag)return void this._loadBasemapsToc(e,this);var o;if(document.getElementById("menuView").style.display="none",document.getElementById("swipeleft").style.display="none",slideLeft(document.getElementById("bookmarkPane")),"undefined"!=typeof hb1298GraphicsLayer&&hb1298GraphicsLayer.clear(),"undefined"!=typeof drawGraphicsLayer){for(o=0;o<drawGraphicsCounter;o++)map.removeLayer(map.getLayer(drawGraphicsCount[o]));drawGraphicsCounter=0,drawGraphicsCount=[]}require(["esri/geometry/Extent","esri/SpatialReference","dojo/dom","dijit/registry","javascript/graphicFuncs"],function(o,a,t,r,i){e=e.replace(/\$/g,";");var s=e.split("&"),n=/([^0-9 \-,\.])/g;s[0]=s[0].replace(n,"");var l,d=s[0].split(",");if(l=new o({xmin:parseFloat(d[0]),ymin:parseFloat(d[1]),xmax:parseFloat(d[2]),ymax:parseFloat(d[3]),spatialReference:{wkid:wkid}}),map.setExtent(l),d=null,1!=s.length){for(var m,c=new a(map.spatialReference),p=1;p<s.length;p++)if(s[p].indexOf("layer=")>-1){s[p]=s[p].substring(6),n=/([^a-zA-Z0-9 =\-\|,\._()])/g,s[p]=s[p].replace(n,"");var g=r.byId("basemapGallery");m=s[p].indexOf("|");for(var u,b=s[p].substring(0,m),h=0;h<g.basemaps.length;h++)if(b==g.basemaps[h].id){u=g.basemaps[h].title;break}for(var k=t.byId("galleryDiv").firstChild.children,y=0;y<k.length;y++)k[y].children[1].childNodes[0].nodeValue==u?(k[y].attributes.class.nodeValue="thumbnailcontainer small selected",k[y].children[0].attributes.class.nodeValue="thumbnail small selected",k[y].children[1].attributes.class.nodeValue="title small selected",k[y].children[2].attributes.class.nodeValue="title small selected"):(k[y].attributes.class.nodeValue="thumbnailcontainer small",k[y].children[0].attributes.class.nodeValue="thumbnail small",k[y].children[1].attributes.class.nodeValue="title small",k[y].children[2].attributes.class.nodeValue="title small");g.select(b),mapBasemap=b;var f,v=s[p].substring(m+1).split(","),B=map.getLayersVisibleAtScale();gmu="Big Game GMU";for(var w,x,_=new Array(0,1,2,3,4,5,6,7,8,9),L=0;L<B.length;L++){var C=!1;for(x=0;x<v.length;x++)w=v[x].split("|"),B[L].id.indexOf("graphics")>-1?C=!0:B[L].id!=w[0]||(C=!0);C||B[L].hide()}for(x=0;x<v.length;x++)for(w=v[x].split("|"),L=0;L<B.length;L++)if(B[L].id==w[0])if(B[L].setOpacity(parseFloat(w[1])),w[3]?"1"==w[3]?B[L].show():B[L].hide():B[L].show(),"-1"==w[2])B[L].setVisibleLayers([-1]);else{for(var j=w[2].split("-"),I=0;I<j.length;I++)j[I]=0|j[I];var E=[];if(E=B[L].layerInfos,"Hunter Reference"==B[L].id){for(f=0;f<j.length;f++)if(E[j[f]].name.substr(E[j[f]].name.length-3,3).indexOf("GMU")>-1){gmu=E[j[f]].name;break}}else if("Game Species"==B[L].id)for(f=0;f<j.length;f++){if("Bighorn Sheep"===E[j[f]].name){gmu="Bighorn GMU";break}if("Mountain Goat"===E[j[f]].name){gmu="Goat GMU";break}}for(I=0;I<E.length;I++)-1!=j.indexOf(E[I].id)?E[I].visible=!0:-1==E[I].parentLayerId||E[I].subLayerIds?E[I].visible=!1:E[I].name.substr(E[I].name.length-3,3).indexOf("GMU")>-1?E[I].name==gmu?(-1==j.indexOf(p)&&(E[I].visible=!0),_.indexOf(parseInt(E[E[I].parentLayerId].name.substr(0,1)))>-1&&-1==j.indexOf(E[I].parentLayerId)&&(E[E[I].parentLayerId].visible=!0)):E[I].visible=!1:1==E[I].defaultVisibility&&-1===j.indexOf(E[I].parentLayerId)&&_.indexOf(parseInt(E[E[I].parentLayerId].name.substr(0,1)))>-1&&(E[E[I].parentLayerId].visible=!0),m=j.indexOf(E[I].id),m>-1&&E[I].subLayerIds&&j.splice(m,1);B[L].setVisibleLayers(j.sort(function(e,o){return e-o}),!1),B[L].refresh(),j=null}}else s[p].indexOf("point=")>-1?require(["javascript/graphicFuncs"],function(e){s[p]=s[p].substring(6),n=/([^a-zA-Z0-9 °\-\'\"\|;,\.!_\*()])/g,s[p]=s[p].replace(n,""),e.addPoints(s[p],c)}):"function"==typeof addHB1298Points&&s[p].indexOf("hb1298=")>-1&&(s[p]=s[p].substring(7),n=/([^a-zA-Z0-9 °\-\'\"\|;,\.!_\*()])/g,s[p]=s[p].replace(n,""),addHB1298Points(s[p]));var G=r.byId("tocDiv");G.refresh()}}),hideLoading()}catch(e){alert("Error in javascript/bookmark.js _loadBookmark() "+e.message,"Code Error",e)}},_removeBookmark:function(e){try{for(var o="",a=getCookie("bm_"+app.toLowerCase()),t=a.split("*"),r=0;r<t.length;r++){var i=t[r];e!=i&&(""!=o&&""!=i&&(o+="*"),o+=t[r])}setCookie("bm_"+app.toLowerCase(),o),deleteCookie("bm"+app.toLowerCase()+"_"+e),d.destroy("link"+e),d.destroy(e),d.destroy("br1"+e),d.destroy("br2"+e)}catch(e){alert("Error in javascript/bookmark.js _removeBookmark() "+e.message,"Code Error",e)}}});return f});